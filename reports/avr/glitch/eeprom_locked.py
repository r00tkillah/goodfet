#!/usr/bin/env python

import sys,binascii,time,random;

sys.path.append('../../../trunk/client/')

from GoodFETAVR import GoodFETAVR;
from intelhex import IntelHex16bit, IntelHex;

#Initialize FET and set baud rate
client=GoodFETAVR();
client.serInit()

#Connect to target
client.start();

#1,000 takes an hour
trials=10; #10,000 is smooth

print "# GoodFET EEPROM Unlock test."
print "# Count of reads with voltage glitch."

client.start();

#Erase chip for baseline.
while(client.eeprompeek(0)!=0xde):
    client.start();
    client.erase();
    client.eeprompoke(0,0xDE);

#Lock chip to unlock it later.
client.setlockbits(0xFC);

#0xfff is full voltage
highv=0x900; #Works, but clock errors are common.
#highv=0xfff;
#highv=0xA00;

#860 to 8a0
#Low end doesn't work at all.
#High end always works.

#887 to 8a0 seems thorough.
start=0x000;
stop=0x400;  #No point glitching to a stable voltage!
skip=0x1;

trials=5
#Time Range
tstart=0x20;
tstop=client.glitchstarttime();
#tstop=0x100;
print "# AVRStart takes %04x cycles." % tstop;
tstep=0x1; #Must be 1


#Restrict range
#tstart=0x0020
#tstop=0x0050

print "# %i trials/point, %i steps/point" % (trials, skip);
print "# DAC Range %04x to %04x" % (start, stop);
print "# Time Range %04x to %04x" % (tstart, tstop);
print "# Generated by GoodFET, http://goodfet.sf.net/"
print "# %i points" % ((stop-start)*(tstop-tstart)*trials/skip)

sys.stdout.flush()

voltages=range(start,stop,skip);
random.shuffle(voltages);
for va in voltages:
    print "# Column %04x" % va;
    for time in range(tstart,tstop,tstep):
        client.glitchVoltages(va, highv);  #Jump voltage.
        #client.glitchVoltages(va, va);    #Hold voltage.
        client.glitchRate(time);
        count=0;
        for i in range(0,trials):
            #Old start
            #client.start();
            #Glitching AVR/Start
            client.glitchstart();
            
            #Try to read *0, which is 0xDE if read works.
            #a=client.eeprompeek(0)
            a=client.lockbits();
            if(a==0xFF):
                count+=1;
            if(client.eeprompeek(0)==0xde):
                print "# HELL YEAH!"
                count+=trials;
        if(count>0):
            print "#Glitched from %04x at %04x" % (va,time);
            print "%f, %f, %f" % (
                va*(3.3/4096.0),time,
                count);
        sys.stdout.flush()
